import os
import argparse

def read_file(file_path):
    try:
        with open(file_path, 'r', encoding='utf-8') as file:
            return file.read()
    except Exception as e:
        return f"Error reading file: {str(e)}"

def main():
    parser = argparse.ArgumentParser(description="Compile project files into a single knowledge base.")
    parser.add_argument("project_dir", help="Full path to the project directory")
    parser.add_argument("--file_paths", default="file_paths.txt", help="Name of the file containing paths (default: file_paths.txt)")
    parser.add_argument("--output", default="project_knowledge.txt", help="Name of the output file (default: project_knowledge.txt)")
    args = parser.parse_args()

    if not os.path.isdir(args.project_dir):
        print(f"Error: The directory '{args.project_dir}' does not exist.")
        exit(1)

    output = ""
    processed_files = 0
    total_files = 0

    script_dir = os.path.dirname(os.path.abspath(__file__))
    file_paths_txt = os.path.join(script_dir, args.file_paths)

    with open(file_paths_txt, 'r') as path_file:
        file_paths = path_file.readlines()
        total_files = len(file_paths)

        for relative_path in file_paths:
            relative_path = relative_path.strip()
            if relative_path:
                file_path = os.path.join(args.project_dir, relative_path)
                print(f"Processing: {file_path}")
                if os.path.exists(file_path):
                    if os.path.isfile(file_path):
                        content = read_file(file_path)
                        output += f"<document>\n<source>{relative_path}</source>\n<document_content>{content}</document_content>\n</document>\n\n"
                        processed_files += 1
                    else:
                        print(f"Skipping directory: {file_path}")
                else:
                    print(f"File not found: {file_path}")

    output_file_path = os.path.join(script_dir, args.output)
    with open(output_file_path, 'w', encoding='utf-8') as output_file:
        output_file.write(output)

    print(f"Project knowledge has been compiled in '{output_file_path}'")
    print(f"Processed {processed_files} out of {total_files} files.")

if __name__ == "__main__":
    main()